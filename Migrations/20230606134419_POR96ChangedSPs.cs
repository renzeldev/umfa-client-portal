using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace ClientPortal.Migrations
{
    public partial class POR96ChangedSPs : Migration
    {
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.Sql("CREATE OR ALTER proc [dbo].[spAlarmAnalyzeBurstPipe]\r\n(\r\n@MeterSerialNo nvarchar(250),\r\n@ProfileStartDTM smalldatetime,\r\n@ProfileEndDTM smalldatetime,\r\n@Threshold decimal(18,4),\r\n@Duration int\r\n)\r\n\r\nAS\r\n\r\n--declare\r\n--@MeterSerialNo nvarchar(250) = '57770290',\r\n--@ProfileStartDTM smalldatetime = '2023-03-01 00:00',\r\n--@ProfileEndDTM smalldatetime = '2023-03-31 23:59',\r\n--@Threshold decimal(18,4) = 0.061,\r\n--@Duration int = 2\r\n\r\ndeclare\r\n@TimeDiff int,\r\n@iCnt int = 1,\r\n@iRows int,\r\n@NoAlarms int = 0\r\n\r\nset @Duration = @Duration * 30\r\n\r\ndeclare @tProfile table (Id int identity(1,1), ProfileId int, SerialNo varchar(250), ReadingDate smalldatetime, P1 decimal(18,4))\r\n\r\ninsert into @tProfile\r\nselect\r\np.Id, p.SerialNumber, p.ReadingDate, p.P1\r\nfrom\r\nScadaProfileData p (NOLOCK)\r\nwhere\r\np.SerialNumber = @MeterSerialNo\r\nand p.IsActive = 1\r\nand p.ReadingDate between @ProfileStartDTM and @ProfileEndDTM\r\norder by p.ReadingDate\r\n\r\nSELECT @TimeDiff =  DATEDIFF(MI, '2023-04-01 00:00', DATEADD(MI, @Duration, '2023-04-01 00:00'))\r\n\r\n--first identify all occurences where threshold was exceeded\r\ndeclare @tResults table (Id int identity(1,1), SerialNo varchar(250), StartDTM smalldatetime, EndDTM smalldatetime, OccDTM smalldatetime, maxUsage decimal(18,4)\r\n\t\t\t\t\t\t, Duration int)\r\n\r\ninsert into @tResults\r\nselect\r\nSerialNo\r\n, ReadingDate\r\n, isnull(LEAD(ReadingDate) OVER (Order by Id), @ProfileEndDTM) as NextDate\r\n, ReadingDate, P1, 0\r\nfrom\r\n(\r\nselect\r\nId, ProfileId, SerialNo, ReadingDate,\r\nLAG(P1) OVER (order by ReadingDate) as PrevP1,\r\nP1, LEAD(P1) OVER (order by ReadingDate) as NextP1\r\nFrom\r\n@tProfile\r\n) a\r\nwhere\r\nP1 > @Threshold and (@Duration = 30 or NextP1 > @Threshold) and PrevP1 <= @Threshold\r\norder by a.ReadingDate\r\n\r\n--select * from @tResults\r\n\r\nset @iRows = @@ROWCOUNT\r\nset @iCnt = 1\r\n\r\ndeclare @SerNo varchar(250), @SDTM smalldatetime, @EDTM smalldatetime, @OccDTM smalldatetime, @maxUsage decimal(18,4), @Dur int\r\n\r\nwhile @iCnt <= @iRows\r\nbegin\r\n\tselect @SerNo = SerialNo, @SDTM = StartDTM, @EDTM = EndDTM, @OccDTM = OccDTM, @maxUsage = maxUsage from @tResults where Id = @iCnt\r\n\r\n\tSELECT\r\n\t\t@Dur = ISNULL(SUM(DATEDIFF(MINUTE, t1.ReadingDate, t2.ReadingDate)), 0)\r\n\tFROM \r\n\t\t@tProfile t1\r\n\t\tJOIN @tProfile t2 ON t2.Id = t1.Id + 1\r\n\tWHERE \r\n\t\tt1.ReadingDate between @OccDTM and @EDTM\r\n\t\tand t1.P1 >= @Threshold AND t2.P1 >= @Threshold\r\n\r\n\t\tupdate @tResults set Duration = @Dur + 30 where Id = @iCnt\r\n\r\n\tset @iCnt += 1\r\nend\r\n\r\n--select * from @tResults\r\n\r\ndeclare @tAlarms table (Id int identity(1,1), AlarmStart smalldatetime, AlarmEnd smalldatetime, Duration int)\r\ninsert into @tAlarms\r\nselect OccDTM as AlarmStart, DATEADD(MI, Duration, OccDTM) as AlarmEnd, Duration from @tResults where Duration >= @Duration\r\n\r\ndeclare @tData table (Id int identity(1,1), ReadingDate smalldatetime, ActFlow decimal(18,4), Calculated bit)\r\n\r\ninsert into @tData\r\nselect\r\nconvert(varchar(16), d.ReadingDate, 120) as ReadingDate,\r\nActFlow = d.P1,\r\nCalculated = case when d.Status = 0 then 0 else 1 end\r\nfrom\r\nScadaProfileData d (NOLOCK)\r\nwhere\r\nd.SerialNumber = @MeterSerialNo\r\nand d.ReadingDate >= @ProfileStartDTM and d.ReadingDate <= @ProfileEndDTM\r\nand d.isActive = 1\r\norder by\r\nd.ReadingDate\r\n\r\nselect d.ReadingDate, d.ActFlow as ActFlow, d.Calculated\r\n,case when (dd.Id is null) then '#00cc00' else 'red' end as Color\r\nfrom @tData d\r\nleft join @tAlarms dd on (d.ReadingDate between dd.AlarmStart and dd.AlarmEnd)\r\n\r\nselect NoOfAlarms = count(1) from @tAlarms");

            migrationBuilder.Sql("CREATE OR ALTER proc [dbo].[spAlarmAnalyzeNightFlow]\r\n(\r\n@MeterSerialNo nvarchar(250),\r\n@ProfileStartDTM smalldatetime,\r\n@ProfileEndDTM smalldatetime,\r\n@NFStartTime time,\r\n@NFEndTime time,\r\n@Threshold decimal(18,4),\r\n@Duration int\r\n)\r\n\r\nAS\r\n\r\n--declare\r\n--@MeterSerialNo nvarchar(250) = '57770290',\r\n--@ProfileStartDTM smalldatetime = '2023-03-01 00:00',\r\n--@ProfileEndDTM smalldatetime = '2023-03-31 23:59',\r\n--@NFStartTime time = '20:00',\r\n--@NFEndTime time = '04:00',\r\n--@Threshold decimal(18,4) = 0.013,\r\n--@Duration int = 2\r\n\r\nset @Duration = @Duration * 30\r\n\r\ndeclare\r\n@TimeDiff int,\r\n@iCnt int = 1,\r\n@iRows int,\r\n@NoAlarms int = 0\r\n\r\ndeclare @tProfile table (Id int identity(1,1), ProfileId int, SerialNo varchar(250), ReadingDate smalldatetime, P1 decimal(18,4))\r\n\r\ninsert into @tProfile\r\nselect\r\np.Id, p.SerialNumber, p.ReadingDate, p.P1\r\nfrom\r\nScadaProfileData p (NOLOCK)\r\nwhere\r\np.SerialNumber = @MeterSerialNo\r\nand p.IsActive = 1\r\nand p.ReadingDate between @ProfileStartDTM and @ProfileEndDTM\r\norder by p.ReadingDate\r\n\r\nSELECT @TimeDiff =  DATEDIFF(MI, CONCAT('2023-04-01 ', @NFStartTime), CONCAT(case when @NFEndTime < @NFStartTime then '2023-04-02 ' else '2023-04-01 ' end, @NFEndTime))\r\n\r\n--first identify all occurences where threshold was exceeded\r\ndeclare @tResults table (Id int identity(1,1), SerialNo varchar(250), StartDTM smalldatetime, EndDTM smalldatetime, OccDTM smalldatetime, maxUsage decimal(18,4)\r\n\t\t\t\t\t\t, Duration int)\r\n\r\ninsert into @tResults\r\nselect\r\nb.SerialNo, b.StartDTM, b.EndDTM\r\n, (select min(ReadingDate) from @tProfile where SerialNo = b.SerialNo and ReadingDate between b.StartDTM and b.EndDTM and P1 >= @Threshold) as OccDTM\r\n, b.maxUsage, 0 as Duration\r\nfrom\r\n(\r\nselect\r\np.SerialNo, a.StartDTM, a.EndDTM, MAX(p.P1) as maxUsage\r\nfrom\r\n@tProfile p\r\njoin\r\n(\r\nselect\r\nId, ProfileId, SerialNo, ReadingDate as StartDTM, DATEADD(MI, @TimeDiff, ReadingDate) as EndDTM\r\nfrom @tProfile\r\nwhere\r\nDATEPART(HH, ReadingDate) = DATEPART(HH, @NFStartTime)\r\nand DATEPART(MI, ReadingDate) = DATEPART(MI, @NFStartTime)\r\n) a on (p.SerialNo = a.SerialNo and p.ReadingDate between a.StartDTM and a.EndDTM)\r\ngroup by\r\np.SerialNo, a.StartDTM, a.EndDTM\r\nhaving MAX(p.P1) > @Threshold\r\n) b\r\n\r\n--select * from @tResults\r\n\r\nset @iRows = @@ROWCOUNT\r\nset @iCnt = 1\r\n\r\ndeclare @SerNo varchar(250), @SDTM smalldatetime, @EDTM smalldatetime, @OccDTM smalldatetime, @maxUsage decimal(18,4), @Dur int\r\n\r\nwhile @iCnt <= @iRows\r\nbegin\r\n\tselect @SerNo = SerialNo, @SDTM = StartDTM, @EDTM = EndDTM, @OccDTM = OccDTM, @maxUsage = maxUsage from @tResults where Id = @iCnt\r\n\tSELECT \r\n\t--*\r\n\t@Dur = ISNULL(SUM(DATEDIFF(MINUTE, t1.ReadingDate, t2.ReadingDate)), 0)\r\nFROM \r\n\t@tProfile t1\r\n\tJOIN @tProfile t2 ON (t2.Id = t1.Id + 1)\r\nWHERE \r\n\tt1.ReadingDate between @OccDTM and @EDTM\r\n\tand t1.P1 >= @Threshold AND t2.P1 >= @Threshold\r\n\r\n\tupdate @tResults set Duration = @Dur + 30 where Id = @iCnt\r\n\r\nset @iCnt += 1\r\nend\r\n\r\n--select * from @tResults\r\n\r\ndeclare @tData table (Id int identity(1,1), ReadingDate smalldatetime, ActFlow decimal(18,4), Calculated bit)\r\n\r\ninsert into @tData\r\nselect\r\nconvert(varchar(16), d.ReadingDate, 120) as ReadingDate,\r\nActFlow = d.P1,\r\nCalculated = case when d.Status = 0 then 0 else 1 end\r\nfrom\r\nScadaProfileData d (NOLOCK)\r\nwhere\r\nd.SerialNumber = @MeterSerialNo\r\nand d.ReadingDate >= @ProfileStartDTM and d.ReadingDate <= @ProfileEndDTM\r\nand d.isActive = 1\r\norder by\r\nd.ReadingDate\r\n\r\nselect d.ReadingDate, d.ActFlow as ActFlow, d.Calculated\r\n,case when (dd.Id is null) then '#00cc00' else 'red' end as Color\r\nfrom @tData d\r\nleft join @tResults dd on (dd.Duration >= @Duration and d.ReadingDate >= dd.OccDTM and d.ReadingDate < DATEADD(MI, dd.Duration, dd.OccDTM))\r\n\r\nselect @NoAlarms = isnull(count(1), 0) from @tResults where Duration >= @Duration\r\n\r\nselect @NoAlarms as NoOfAlarms");

            migrationBuilder.Sql("CREATE OR ALTER proc [dbo].[spAlarmAnalyzeLeakDetection]\r\n(\r\n@MeterSerialNo nvarchar(250),\r\n@ProfileStartDTM smalldatetime,\r\n@ProfileEndDTM smalldatetime,\r\n@StartTime time,\r\n@EndTime time,\r\n@Threshold decimal(18,4),\r\n@Duration int\r\n)\r\n\r\nAS\r\n\r\n--declare\r\n--@MeterSerialNo nvarchar(250) = '57770290',\r\n--@ProfileStartDTM smalldatetime = '2023-03-01 00:00',\r\n--@ProfileEndDTM smalldatetime = '2023-03-31 23:59',\r\n--@StartTime time = '20:00',\r\n--@EndTime time = '04:00',\r\n--@Threshold decimal(18,4) = 0.002,\r\n--@Duration int = 3\r\n\r\nset @Duration = @Duration * 30\r\n\r\ndeclare\r\n@TimeDiff int,\r\n@iCnt int = 1,\r\n@iRows int,\r\n@NoAlarms int = 0\r\n\r\ndeclare @tProfile table (Id int identity(1,1), ProfileId int, SerialNo varchar(250), ReadingDate smalldatetime, P1 decimal(18,4))\r\n\r\ninsert into @tProfile\r\nselect\r\np.Id, p.SerialNumber, p.ReadingDate, p.P1\r\nfrom\r\nScadaProfileData p (NOLOCK)\r\nwhere\r\np.SerialNumber = @MeterSerialNo\r\nand p.IsActive = 1\r\nand p.ReadingDate between @ProfileStartDTM and @ProfileEndDTM\r\norder by p.ReadingDate\r\n\r\nSELECT @TimeDiff =  DATEDIFF(MI, CONCAT('2023-04-01 ', @StartTime), CONCAT(case when @EndTime < @StartTime then '2023-04-02 ' else '2023-04-01 ' end, @EndTime))\r\n\r\n--first identify all occurences where threshold was exceeded\r\ndeclare @tResults table (Id int identity(1,1), SerialNo varchar(250), StartDTM smalldatetime, EndDTM smalldatetime, OccDTM smalldatetime, minUsage decimal(18,4)\r\n\t\t\t\t\t\t, Duration int)\r\n\r\ninsert into @tResults\r\nselect\r\nb.SerialNo, b.StartDTM, b.EndDTM\r\n, (select min(ReadingDate) from @tProfile where SerialNo = b.SerialNo and ReadingDate between b.StartDTM and b.EndDTM and P1 >= @Threshold) as OccDTM\r\n, b.minUsage, 0 as Duration\r\nfrom\r\n(\r\nselect\r\np.SerialNo, a.StartDTM, a.EndDTM, max(p.P1) as minUsage\r\nfrom\r\n@tProfile p\r\njoin\r\n(\r\nselect\r\nId, ProfileId, SerialNo, ReadingDate as StartDTM, DATEADD(MI, @TimeDiff, ReadingDate) as EndDTM\r\nfrom @tProfile\r\nwhere\r\nDATEPART(HH, ReadingDate) = DATEPART(HH, @StartTime)\r\nand DATEPART(MI, ReadingDate) = DATEPART(MI, @StartTime)\r\n) a on (p.SerialNo = a.SerialNo and p.ReadingDate between a.StartDTM and a.EndDTM)\r\ngroup by\r\np.SerialNo, a.StartDTM, a.EndDTM\r\nhaving max(p.P1) > @Threshold\r\n) b\r\n\r\nset @iRows = @@ROWCOUNT\r\nset @iCnt = 1\r\n\r\ndeclare @SerNo varchar(250), @SDTM smalldatetime, @EDTM smalldatetime, @OccDTM smalldatetime, @maxUsage decimal(18,4), @Dur int\r\n\r\nwhile @iCnt <= @iRows\r\nbegin\r\n\tselect @SerNo = SerialNo, @SDTM = StartDTM, @EDTM = EndDTM, @OccDTM = OccDTM, @maxUsage = minUsage from @tResults where Id = @iCnt\r\n\r\n\tSELECT \r\n\t\t--*\r\n\t\t@Dur = ISNULL(SUM(DATEDIFF(MINUTE, t1.ReadingDate, t2.ReadingDate)), 0)\r\n\tFROM \r\n\t\t@tProfile t1\r\n\t\tJOIN @tProfile t2 ON t2.Id = t1.Id + 1\r\n\tWHERE \r\n\t\tt1.ReadingDate between @OccDTM and @EDTM\r\n\t\tand t1.P1 >= @Threshold AND t2.P1 >= @Threshold\r\n\r\n\t\tupdate @tResults set Duration = @Dur + 30 where Id = @iCnt\r\n\r\n\tset @iCnt += 1\r\nend\r\n\r\n--select * from @tResults\r\n\r\ndeclare @tData table (Id int identity(1,1), ReadingDate smalldatetime, ActFlow decimal(18,4), Calculated bit)\r\n\r\ninsert into @tData\r\nselect\r\nconvert(varchar(16), d.ReadingDate, 120) as ReadingDate,\r\nActFlow = d.P1,\r\nCalculated = case when d.Status = 0 then 0 else 1 end\r\nfrom\r\nScadaProfileData d (NOLOCK)\r\nwhere\r\nd.SerialNumber = @MeterSerialNo\r\nand d.ReadingDate >= @ProfileStartDTM and d.ReadingDate <= @ProfileEndDTM\r\nand d.isActive = 1\r\norder by\r\nd.ReadingDate\r\n\r\nselect d.ReadingDate, d.ActFlow as ActFlow, d.Calculated\r\n,case when (dd.Id is null) then '#00cc00' else 'red' end as Color\r\nfrom @tData d\r\nleft join @tResults dd on (dd.Duration >= @Duration and d.ReadingDate >= dd.OccDTM and d.ReadingDate < DATEADD(MI, dd.Duration, dd.OccDTM))\r\n\r\nselect @NoAlarms = isnull(count(1), 0) from @tResults where Duration >= @Duration\r\n\r\nselect @NoAlarms as NoOfAlarms");
        }

        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.Sql("CREATE OR ALTER proc [dbo].[spAlarmAnalyzeBurstPipe]\r\n(\r\n@MeterSerialNo nvarchar(250),\r\n@ProfileStartDTM smalldatetime,\r\n@ProfileEndDTM smalldatetime,\r\n@Threshold decimal(18,4),\r\n@Duration int\r\n)\r\n\r\nAS\r\n\r\n--declare\r\n--@MeterSerialNo nvarchar(250) = '57770290',\r\n--@ProfileStartDTM smalldatetime = '2023-02-01 00:00',\r\n--@ProfileEndDTM smalldatetime = '2023-02-28 23:59',\r\n--@Threshold decimal(18,4) = 0.04,\r\n--@Duration int = 2\r\n\r\ndeclare\r\n@TimeDiff int,\r\n@iCnt int = 1,\r\n@iRows int,\r\n@NoAlarms int = 0\r\n\r\nset @Duration = @Duration * 30\r\n\r\ndeclare @tProfile table (Id int identity(1,1), ProfileId int, SerialNo varchar(250), ReadingDate smalldatetime, P1 decimal(18,4))\r\n\r\ninsert into @tProfile\r\nselect\r\np.Id, p.SerialNumber, p.ReadingDate, p.P1\r\nfrom\r\nScadaProfileData p (NOLOCK)\r\nwhere\r\np.SerialNumber = @MeterSerialNo\r\nand p.IsActive = 1\r\nand p.ReadingDate between @ProfileStartDTM and @ProfileEndDTM\r\norder by p.ReadingDate\r\n\r\nSELECT @TimeDiff =  DATEDIFF(MI, '2023-04-01 00:00', DATEADD(MI, @Duration, '2023-04-01 00:00'))\r\n\r\n--first identify all occurences where threshold was exceeded\r\ndeclare @tResults table (Id int identity(1,1), SerialNo varchar(250), StartDTM smalldatetime, EndDTM smalldatetime, OccDTM smalldatetime, maxUsage decimal(18,4)\r\n\t\t\t\t\t\t, Duration int)\r\n\r\ninsert into @tResults\r\nselect\r\nSerialNo\r\n, ReadingDate\r\n, isnull(LEAD(ReadingDate) OVER (Order by Id), @ProfileEndDTM) as NextDate\r\n, ReadingDate, P1, 0\r\nfrom\r\n(\r\nselect\r\nId, ProfileId, SerialNo, ReadingDate,\r\nLAG(P1) OVER (order by ReadingDate) as PrevP1,\r\nP1, LEAD(P1) OVER (order by ReadingDate) as NextP1\r\nFrom\r\n@tProfile\r\n) a\r\nwhere\r\nP1 > @Threshold and NextP1 > @Threshold and PrevP1 <= @Threshold\r\norder by a.ReadingDate\r\n\r\nset @iRows = @@ROWCOUNT\r\nset @iCnt = 1\r\n\r\ndeclare @SerNo varchar(250), @SDTM smalldatetime, @EDTM smalldatetime, @OccDTM smalldatetime, @maxUsage decimal(18,4), @Dur int\r\n\r\nwhile @iCnt <= @iRows\r\nbegin\r\n\tselect @SerNo = SerialNo, @SDTM = StartDTM, @EDTM = EndDTM, @OccDTM = OccDTM, @maxUsage = maxUsage from @tResults where Id = @iCnt\r\n\r\nSELECT\r\n\t@Dur = ISNULL(SUM(DATEDIFF(MINUTE, t1.ReadingDate, t2.ReadingDate)), 0)\r\nFROM \r\n\t@tProfile t1\r\n\tJOIN @tProfile t2 ON t2.Id = t1.Id + 1\r\nWHERE \r\n\tt1.ReadingDate between @OccDTM and @EDTM\r\n\tand t1.P1 >= @Threshold AND t2.P1 >= @Threshold\r\n\r\n\tupdate @tResults set Duration = @Dur where Id = @iCnt\r\n\r\nset @iCnt += 1\r\nend\r\n\r\ndeclare @tAlarms table (Id int identity(1,1), AlarmStart smalldatetime, AlarmEnd smalldatetime, Duration int)\r\ninsert into @tAlarms\r\nselect OccDTM as AlarmStart, DATEADD(MI, Duration, OccDTM) as AlarmEnd, Duration from @tResults where Duration >= @Duration\r\n\r\ndeclare @tData table (Id int identity(1,1), ReadingDate smalldatetime, ActFlow decimal(18,4), Calculated bit)\r\n\r\ninsert into @tData\r\nselect\r\nconvert(varchar(16), d.ReadingDate, 120) as ReadingDate,\r\nActFlow = d.P1,\r\nCalculated = case when d.Status = 0 then 0 else 1 end\r\nfrom\r\nScadaProfileData d (NOLOCK)\r\nwhere\r\nd.SerialNumber = @MeterSerialNo\r\nand d.ReadingDate >= @ProfileStartDTM and d.ReadingDate <= @ProfileEndDTM\r\nand d.isActive = 1\r\norder by\r\nd.ReadingDate\r\n\r\nselect d.ReadingDate, d.ActFlow as ActFlow, d.Calculated\r\n,case when (dd.Id is null) then '#00cc00' else 'red' end as Color\r\nfrom @tData d\r\nleft join @tAlarms dd on (d.ReadingDate between dd.AlarmStart and dd.AlarmEnd)\r\n\r\nselect NoOfAlarms = count(1) from @tAlarms");

            migrationBuilder.Sql("CREATE OR ALTER proc [dbo].[spAlarmAnalyzeNightFlow]\r\n(\r\n@MeterSerialNo nvarchar(250),\r\n@ProfileStartDTM smalldatetime,\r\n@ProfileEndDTM smalldatetime,\r\n@NFStartTime time,\r\n@NFEndTime time,\r\n@Threshold decimal(18,4),\r\n@Duration int\r\n)\r\n\r\nAS\r\n\r\n--declare\r\n--@MeterSerialNo nvarchar(250) = '57770290',\r\n--@ProfileStartDTM smalldatetime = '2023-02-01 00:00',\r\n--@ProfileEndDTM smalldatetime = '2023-02-28 23:59',\r\n--@NFStartTime time = '22:00',\r\n--@NFEndTime time = '05:00',\r\n--@Threshold decimal(18,4) = 0.02,\r\n--@Duration int = 60\r\n\r\ndeclare\r\n@TimeDiff int,\r\n@iCnt int = 1,\r\n@iRows int,\r\n@NoAlarms int = 0\r\n\r\ndeclare @tProfile table (Id int identity(1,1), ProfileId int, SerialNo varchar(250), ReadingDate smalldatetime, P1 decimal(18,4))\r\n\r\ninsert into @tProfile\r\nselect\r\np.Id, p.SerialNumber, p.ReadingDate, p.P1\r\nfrom\r\nScadaProfileData p (NOLOCK)\r\nwhere\r\np.SerialNumber = @MeterSerialNo\r\nand p.IsActive = 1\r\nand p.ReadingDate between @ProfileStartDTM and @ProfileEndDTM\r\norder by p.ReadingDate\r\n\r\nSELECT @TimeDiff =  DATEDIFF(MI, CONCAT('2023-04-01 ', @NFStartTime), CONCAT(case when @NFEndTime < @NFStartTime then '2023-04-02 ' else '2023-04-01 ' end, @NFEndTime))\r\n\r\n--first identify all occurences where threshold was exceeded\r\ndeclare @tResults table (Id int identity(1,1), SerialNo varchar(250), StartDTM smalldatetime, EndDTM smalldatetime, OccDTM smalldatetime, maxUsage decimal(18,4)\r\n\t\t\t\t\t\t, Duration int)\r\n\r\ninsert into @tResults\r\nselect\r\nb.SerialNo, b.StartDTM, b.EndDTM\r\n, (select min(ReadingDate) from @tProfile where SerialNo = b.SerialNo and ReadingDate between b.StartDTM and b.EndDTM and P1 >= @Threshold) as OccDTM\r\n, b.maxUsage, 0 as Duration\r\nfrom\r\n(select\r\np.SerialNo, a.StartDTM, a.EndDTM, MAX(p.P1) as maxUsage\r\nfrom\r\n@tProfile p\r\njoin\r\n(select\r\nId, ProfileId, SerialNo, ReadingDate as StartDTM, DATEADD(MI, @TimeDiff, ReadingDate) as EndDTM\r\nfrom @tProfile\r\nwhere\r\nDATEPART(HH, ReadingDate) = DATEPART(HH, @NFStartTime)\r\nand DATEPART(MI, ReadingDate) = DATEPART(MI, @NFStartTime)\r\n) a on (p.SerialNo = a.SerialNo and p.ReadingDate between a.StartDTM and a.EndDTM)\r\ngroup by\r\np.SerialNo, a.StartDTM, a.EndDTM\r\nhaving MAX(p.P1) > @Threshold\r\n) b\r\n\r\nset @iRows = @@ROWCOUNT\r\nset @iCnt = 1\r\n\r\ndeclare @SerNo varchar(250), @SDTM smalldatetime, @EDTM smalldatetime, @OccDTM smalldatetime, @maxUsage decimal(18,4), @Dur int\r\n\r\nwhile @iCnt <= @iRows\r\nbegin\r\n\tselect @SerNo = SerialNo, @SDTM = StartDTM, @EDTM = EndDTM, @OccDTM = OccDTM, @maxUsage = maxUsage from @tResults where Id = @iCnt\r\n\tSELECT \r\n\t@Dur = ISNULL(SUM(DATEDIFF(MINUTE, t1.ReadingDate, t2.ReadingDate)), 0)\r\nFROM \r\n\t@tProfile t1\r\n\tJOIN @tProfile t2 ON t2.Id = t1.Id + 1\r\nWHERE \r\n\tt1.ReadingDate between @OccDTM and @EDTM\r\n\tand t1.P1 >= @Threshold AND t2.P1 >= @Threshold\r\n\r\n\tupdate @tResults set Duration = @Dur where Id = @iCnt\r\n\r\nset @iCnt += 1\r\nend\r\n\r\ndeclare @tData table (Id int identity(1,1), ReadingDate smalldatetime, ActFlow decimal(18,4), Calculated bit)\r\n\r\ninsert into @tData\r\nselect\r\nconvert(varchar(16), d.ReadingDate, 120) as ReadingDate,\r\nActFlow = d.P1,\r\nCalculated = case when d.Status = 0 then 0 else 1 end\r\nfrom\r\nScadaProfileData d (NOLOCK)\r\nwhere\r\nd.SerialNumber = @MeterSerialNo\r\nand d.ReadingDate >= @ProfileStartDTM and d.ReadingDate <= @ProfileEndDTM\r\nand d.isActive = 1\r\norder by\r\nd.ReadingDate\r\n\r\nselect d.ReadingDate, d.ActFlow as ActFlow, d.Calculated\r\n,case when (dd.Id is null) then '#00cc00' else 'red' end as Color\r\nfrom @tData d\r\nleft join @tResults dd on (dd.Duration >= @Duration and d.ReadingDate between dd.OccDTM and DATEADD(MI, dd.Duration, dd.OccDTM))\r\n\r\nselect @NoAlarms = isnull(count(1), 0) from @tResults where Duration >= @Duration\r\n\r\nselect @NoAlarms as NoOfAlarms");

            migrationBuilder.Sql("CREATE OR ALTER proc [dbo].[spAlarmAnalyzeLeakDetection]\r\n(\r\n@MeterSerialNo nvarchar(250),\r\n@ProfileStartDTM smalldatetime,\r\n@ProfileEndDTM smalldatetime,\r\n@StartTime time,\r\n@EndTime time,\r\n@Threshold decimal(18,4),\r\n@Duration int\r\n)\r\n\r\nAS\r\n\r\n--declare\r\n--@MeterSerialNo nvarchar(250) = '57770290',\r\n--@ProfileStartDTM smalldatetime = '2023-02-01 00:00',\r\n--@ProfileEndDTM smalldatetime = '2023-02-28 23:59',\r\n--@StartTime time = '20:00',\r\n--@EndTime time = '04:00',\r\n--@Threshold decimal(18,4) = 0.002,\r\n--@Duration int = 60\r\n\r\ndeclare\r\n@TimeDiff int,\r\n@iCnt int = 1,\r\n@iRows int,\r\n@NoAlarms int = 0\r\n\r\ndeclare @tProfile table (Id int identity(1,1), ProfileId int, SerialNo varchar(250), ReadingDate smalldatetime, P1 decimal(18,4))\r\n\r\ninsert into @tProfile\r\nselect\r\np.Id, p.SerialNumber, p.ReadingDate, p.P1\r\nfrom\r\nScadaProfileData p (NOLOCK)\r\nwhere\r\np.SerialNumber = @MeterSerialNo\r\nand p.IsActive = 1\r\nand p.ReadingDate between @ProfileStartDTM and @ProfileEndDTM\r\norder by p.ReadingDate\r\n\r\nSELECT @TimeDiff =  DATEDIFF(MI, CONCAT('2023-04-01 ', @StartTime), CONCAT(case when @EndTime < @StartTime then '2023-04-02 ' else '2023-04-01 ' end, @EndTime))\r\n\r\n--first identify all occurences where threshold was exceeded\r\ndeclare @tResults table (Id int identity(1,1), SerialNo varchar(250), StartDTM smalldatetime, EndDTM smalldatetime, OccDTM smalldatetime, minUsage decimal(18,4)\r\n\t\t\t\t\t\t, Duration int)\r\n\r\ninsert into @tResults\r\nselect\r\nb.SerialNo, b.StartDTM, b.EndDTM\r\n, (select min(ReadingDate) from @tProfile where SerialNo = b.SerialNo and ReadingDate between b.StartDTM and b.EndDTM and P1 >= @Threshold) as OccDTM\r\n, b.minUsage, 0 as Duration\r\nfrom\r\n(\r\nselect\r\np.SerialNo, a.StartDTM, a.EndDTM, max(p.P1) as minUsage\r\nfrom\r\n@tProfile p\r\njoin\r\n(\r\nselect\r\nId, ProfileId, SerialNo, ReadingDate as StartDTM, DATEADD(MI, @TimeDiff, ReadingDate) as EndDTM\r\nfrom @tProfile\r\nwhere\r\nDATEPART(HH, ReadingDate) = DATEPART(HH, @StartTime)\r\nand DATEPART(MI, ReadingDate) = DATEPART(MI, @StartTime)\r\n) a on (p.SerialNo = a.SerialNo and p.ReadingDate between a.StartDTM and a.EndDTM)\r\ngroup by\r\np.SerialNo, a.StartDTM, a.EndDTM\r\nhaving max(p.P1) > @Threshold\r\n) b\r\n\r\nset @iRows = @@ROWCOUNT\r\nset @iCnt = 1\r\n\r\ndeclare @SerNo varchar(250), @SDTM smalldatetime, @EDTM smalldatetime, @OccDTM smalldatetime, @maxUsage decimal(18,4), @Dur int\r\n\r\nwhile @iCnt <= @iRows\r\nbegin\r\n\tselect @SerNo = SerialNo, @SDTM = StartDTM, @EDTM = EndDTM, @OccDTM = OccDTM, @maxUsage = minUsage from @tResults where Id = @iCnt\r\n\r\nSELECT \r\n\t@Dur = ISNULL(SUM(DATEDIFF(MINUTE, t1.ReadingDate, t2.ReadingDate)), 0)\r\nFROM \r\n\t@tProfile t1\r\n\tJOIN @tProfile t2 ON t2.Id = t1.Id + 1\r\nWHERE \r\n\tt1.ReadingDate between @OccDTM and @EDTM\r\n\tand t1.P1 >= @Threshold AND t2.P1 >= @Threshold\r\n\r\n\tupdate @tResults set Duration = @Dur where Id = @iCnt\r\n\r\nset @iCnt += 1\r\nend\r\n\r\ndeclare @tData table (Id int identity(1,1), ReadingDate smalldatetime, ActFlow decimal(18,4), Calculated bit)\r\n\r\ninsert into @tData\r\nselect\r\nconvert(varchar(16), d.ReadingDate, 120) as ReadingDate,\r\nActFlow = d.P1,\r\nCalculated = case when d.Status = 0 then 0 else 1 end\r\nfrom\r\nScadaProfileData d (NOLOCK)\r\nwhere\r\nd.SerialNumber = @MeterSerialNo\r\nand d.ReadingDate >= @ProfileStartDTM and d.ReadingDate <= @ProfileEndDTM\r\nand d.isActive = 1\r\norder by\r\nd.ReadingDate\r\n\r\nselect d.ReadingDate, d.ActFlow as ActFlow, d.Calculated\r\n,case when (dd.Id is null) then '#00cc00' else 'red' end as Color\r\nfrom @tData d\r\nleft join @tResults dd on (dd.Duration >= @Duration and d.ReadingDate >= dd.OccDTM and d.ReadingDate < DATEADD(MI, dd.Duration, dd.OccDTM))\r\n\r\nselect @NoAlarms = isnull(count(1), 0) from @tResults where Duration >= @Duration\r\n\r\nselect @NoAlarms as NoOfAlarms");
        }
    }
}
